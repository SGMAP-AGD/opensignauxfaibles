---
title: "Light gradient boosting pipe"
author: "Pierre Camilleri"
date: "1 juin 2018"
output: html_document
---

## Imports
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Libraries
library(tidyverse)
library(h2o)
library(lubridate)
library(assertthat)
library(mongolite)
library(broom)
library(MLmetrics)
library(tibbletime)
library(PRROC)
library(broom)
library(rprojroot)
library(groupdata2)
library(R.utils)

sourceDirectory(find_rstudio_root_file('tools'), modifiedOnly = FALSE)
```

## Script parameters
```{r}
database <- "test_signauxfaibles"
actual_period <- as.Date("2018-11-01")
last_batch <- '1812'
algorithm <- 'algo2'
min_effectif <- 300
retrain_model <- TRUE
reexport_csv <- FALSE
```

```{r}
res <- light_gradient_boosting(database, actual_period, last_batch, algorithm, min_effectif, retrain_model = retrain_model, reexport_csv = reexport_csv)
my_data <- res[["current_data"]]
my_model <- res[["model"]]
```

```{r}
my_data <- as.data.frame(my_data)
my_data <- my_data %>% mutate(
  periode =  as.Date(structure(periode / 1000, 
                               class = c('POSIXct','POSIXt')))
)
```

```{r}
shapley_plot(c("81755759800023" ,"82452612300024" ,"49442016900026" ,"34323685700045" ,"64282087200025" ,"87695038700020" ,"40256514700020" ,"35342749500018" ,"40207811700015" ,"83063258400017"), my_data, my_model, batch = last_batch)
```

```{r results="hide"}
export_fiche_visite(sirets = c("39249938000013"), database, last_batch, with_urssaf = TRUE)
```

---
title: "Random forest pipe"
author: "Pierre Camilleri"
date: "1 juin 2018"
output: html_document
---

## Imports
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Libraries
library(tidyverse)
library(tricky)
library(lubridate)
library(assertthat)
library(mongolite)
library(mice)
library(caret)
library(broom)
library(randomForest)
library(MLmetrics)
library(tibbletime)
library(PRROC)
library(broom)
library(rprojroot)

# Sources

source(find_rstudio_root_file('tools','interface','connect_to_database.R'))
source(find_rstudio_root_file('tools','data_prep','impute_missing_data_BdF.R'))
source(find_rstudio_root_file('tools','objective','objective_RJ_LJ_PS.R'))
source(find_rstudio_root_file('tools','objective','objective_default_or_failure.R'))
source(find_rstudio_root_file('tools','objective','set_objective.R'))
source(find_rstudio_root_file('tools','split','split_snapshot_rdm_month.R'))
source(find_rstudio_root_file('tools','split','assert_split_consistency.R'))
source(find_rstudio_root_file('tools','utilities','elapsed_months.R'))
source(find_rstudio_root_file('tools','post_analysis','predict_at.R'))
source(find_rstudio_root_file('tools','post_analysis','prepare_for_export.R'))
source(find_rstudio_root_file('tools','post_analysis','export.R'))
source(find_rstudio_root_file('tools','models','caret_prob.R'))
source(find_rstudio_root_file('tools','models','model_tune.R'))
source(find_rstudio_root_file('tools','models','model_cv_eval.R'))
source(find_rstudio_root_file('tools','post_analysis','compare_prediction_probabilities.R'))



```

## Definition periode actuelle
```{r}
actual_period <- as.Date("2018-05-01")
```


## Recuperation des données dans MongoDB
```{r}
raw_data <- connect_to_database('Features')
```

## Definition de l'objectif
```{r}
raw_data <- raw_data %>% 
  objective_default_or_failure(n_months = 3, threshold = 1, lookback = 18) %>%
  objective_RJ_LJ_PS() %>% 
  set_objective('default')
```

## Feature engineering

```{r}

libelle_naf_simplifie <- raw_data$libelle_naf_niveau1 
libelle_naf_simplifie[libelle_naf_simplifie %in% c(
  'Enseignement',
  'Activités extra-territoriales',
  'Administration publique',
  'Agriculture, sylviculture et pêche')] <- 
  'autre'

raw_data <- raw_data %>% 
  mutate(libelle_naf_simplifie = libelle_naf_simplifie) 

```
## Imputation des données manquantes

Uniquement si les données Banque de France ont été importées

```{r}
seed <- 1234
imputed_data_long <-  impute_missing_data_BdF(raw_data,3,3,seed)
imputed_data <- imputed_data_long %>% filter(.imp==1) %>% select(-.imp) %>% as_tbl_time(periode)
```

## Split train test 

Avec suréchantillonnage. Les suréchantillons seront supprimés à la main dans les échantillons d'entraînement pour s'assurer une évaluation sur le même échantillon de validation croisé. 

```{r}
seed <- 10011

samples <-
  split_snapshot_rdm_month(
    imputed_data,
    date_inf = as.Date("2014-01-01"),
    date_sup = as.Date("2016-01-01"),
    frac_train = 0.7,
    frac_cross = 0.3,
    frac_eyeball = 0,
    seed = seed
  )

sample_train <- samples$train %>% 
  left_join(imputed_data, by = c('siret','periode'))

cv_folds <- samples$cv_fold

assert_split_consistency(sample_train,cv_folds)
```

## Model

Avec foret aleatoire

```{r}
source(find_rstudio_root_file('tools','models','model_predict_random_forest.R'))
```


```{r}
set.seed(1900)

formula_with_bdf <-  outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  ratio_dettecumulee_cotisation_12m + indicatrice_dettecumulee_12m + 
  taux_marge + financier_court_terme + frais_financier + delai_fournisseur + poids_frng + dette_fiscale 


#   tune_grid = expand.grid(mtry = c(2,3,4))
#   
# opt_mtry <- model_tune(function(x,y,z) model_predict_random_forest(formula_with_bdf,x,y,z),
#                        sample_train, 
#                        cv_folds, 
#                        tune_grid)

rf <- model_predict_random_forest(formula_with_bdf,sample_train, mtry = 4)
rf <- rf$model

```


## Prediction
```{r}

#provisoire: retrait NA et inf
tw_complete_long <- imputed_data_long %>%
  filter(.imp != 0) %>% 
  filter(!is.infinite(log_cotisationdue_effectif)) %>%
  filter(!is.na(log_cotisationdue_effectif))


prediction <- predict_at(actual_period,
                         tw_complete_long,
                         function(x) caret_prob(rf,x))

predicted_data <- prediction %>% 
  left_join(raw_data,by = c('siret','periode'))  

# Export
predicted_data %>% 
  prepare_for_export() %>% 
  export(batch = "1806")

```


# Comparing several inputs
```{r}
formulas <- list(
  reference = formula_with_bdf,
    
  without_bdf =  outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  ratio_dettecumulee_cotisation_12m + indicatrice_dettecumulee_12m,
  
  with_naf =  outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  ratio_dettecumulee_cotisation_12m + indicatrice_dettecumulee_12m + 
  taux_marge + financier_court_terme + frais_financier + delai_fournisseur +   poids_frng + dette_fiscale +
  libelle_naf_simplifie
)


results <-  lapply(formulas, function (formula){ 
      output <- model_cv_eval(function(y,z) random_predict_random_forest(formula,y,z,opt_mtry),sample_train,cv_folds, opt_mtry);
      return(output$AUCPR_default)
  })

```

Compare with and without bdf
```{r}

output_with <- model_predict_random_forest(formulas$reference,sample_train,mtry = 4)
prediction_with <- predict_at(actual_period,
                         tw_complete_long,
                         function(x) caret_prob(output_with$model,x))

output_without <- model_predict_random_forest(formulas$without_bdf,sample_train,mtry = 4)
prediction_without <- predict_at(actual_period,
                         tw_complete_long,
                         function(x) caret_prob(output_without$model,x))

joined <- compare_prediction_probabilities(sample_start = prediction_without,
                                           sample_end = prediction_with) %>% 
  left_join(raw_data,by = c('siret','periode')) %>% 
  prepare_for_export(additional_names = c('diff','prob_old'))

joined %>% export(batch = '1806')
```
 

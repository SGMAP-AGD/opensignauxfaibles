---
title: "BoostedTrees"
author: "Pierre Camilleri"
date: "5 avril 2018"
output: html_document
---
```{r}
library("opensignauxfaibles")
library("dplyr")
library("tidyverse")
library("mice")
library("R.utils")
library("nnet")
library("caret")
library("lazyeval")
sourceDirectory("../tools",recursive = TRUE, modifiedOnly = FALSE,verbose = FALSE)
source('./data_pipes/data_prep_RJLJ_12m_OSbyMonths_Paul_Antoine.R')
```

```{r}
formulas_0_12 <- list(
  "effectif" = outcome ~ cut_effectif,
  "cotisation_effectif" = outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif,
  "dettecumulee" = outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  log_ratio_dettecumulee_cotisation + indicatrice_dettecumulee,
  "croissancedettecumulee" = outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  log_ratio_dettecumulee_cotisation + indicatrice_dettecumulee +
  indicatrice_croissance_dettecumulee,
  "nb_debits" = outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  log_ratio_dettecumulee_cotisation + indicatrice_dettecumulee +
  indicatrice_croissance_dettecumulee +
  nb_debits,
  "delais" = outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  log_ratio_dettecumulee_cotisation + indicatrice_dettecumulee +
  indicatrice_croissance_dettecumulee +
  nb_debits +
  delai + delai_sup_6mois,
  "codenaf" = outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  log_ratio_dettecumulee_cotisation + indicatrice_dettecumulee +
  indicatrice_croissance_dettecumulee +
  nb_debits +
  delai + delai_sup_6mois +
  libelle_naf_niveau1,
  "delais_bdf" = outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  log_ratio_dettecumulee_cotisation + indicatrice_dettecumulee +
  indicatrice_croissance_dettecumulee +
  nb_debits +
  delai + delai_sup_6mois + neglog(taux_marge) + log(financier_ct + 0.01) + financier + delai_fournisseur,
  "delais_bdf2" = outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  log_ratio_dettecumulee_cotisation + indicatrice_dettecumulee +
  indicatrice_croissance_dettecumulee +
  nb_debits +
  delai + delai_sup_6mois + taux_marge + financier_ct,
  "delais_bdf3" = outcome ~ cut_effectif + cut_growthrate + lag_effectif_missing +
  apart_last12_months + apart_consommee + apart_share_heuresconsommees +
  log_cotisationdue_effectif +
  log_ratio_dettecumulee_cotisation + indicatrice_dettecumulee +
  indicatrice_croissance_dettecumulee +
  nb_debits +   delai + delai_sup_6mois +
  taux_marge + financier_ct + financier + delai_fournisseur + poids_frng + dette_fiscale
  )
```

```{r}

# IMBALANCE

ctrl <-
  trainControl(
  method = "cv",
  classProbs = TRUE,
  summaryFunction = prSummary,
  savePredictions = "all",
  index = cv_folds
  ) 

formula <- formulas_0_12$dettecumulee
rf1_raw <- train(formula, 
                  data = sample_train, 
                  method = 'rf',
                  metric = 'AUC',
                  trControl = ctrl,
                  tuneLength = 10,
                 na.action = "na.omit")

formula2 <- formulas_0_12$delais_bdf2
rf2_raw <- train(formula2, 
                  data = sample_train, 
                  method = 'rf',
                  metric = 'AUC',
                  trControl = ctrl,
                  tuneLength = 10,
                 na.action = "na.omit")

formula3 <- formulas_0_12$delais_bdf3
rf3_raw <- train(formula3, 
                  data = sample_train, 
                  method = 'rf',
                  metric = 'AUC',
                  trControl = ctrl,
                  tuneLength = 10,
                 na.action = "na.omit")






```

```{r}
# WEIGHTS 

myWeights <- ifelse(sample_train$outcome == "default",
                  (1 / table(sample_train$outcome)[1]) * 0.5,
                  (1 / table(sample_train$outcome)[2]) * 0.5)

ctrl$weights <- myWeights


formula <- formulas_0_12$dettecumulee
logmodel1_wei <- train(formula, 
                  data = sample_train, 
                  method = 'glm',
                  family = binomial,
                  metric = 'AUC',
                  trControl = ctrl,
                  maxit = 2000,
                 na.action = "na.omit")

formula2 <- formulas_0_12$delais_bdf2
logmodel2_wei <- train(formula2, 
                  data = sample_train, 
                  method = 'glm',
                  family = binomial,
                  metric = 'AUC',
                  trControl = ctrl,
                  maxit = 2000,
                 na.action = "na.omit")
ctrl$weights <- NA
```

```{r}
# downsampling
ctrl$sampling = "down"

formula <- formulas_0_12$dettecumulee
logmodel1_down <- train(formula, 
                  data = sample_train, 
                  method = 'glm',
                  family = binomial,
                  metric = 'AUC',
                  trControl = ctrl,
                  maxit = 2000,
                 na.action = "na.omit")

formula2 <- formulas_0_12$delais_bdf2
logmodel2_down <- train(formula2, 
                  data = sample_train, 
                  method = 'glm',
                  family = binomial,
                  metric = 'AUC',
                  trControl = ctrl,
                  maxit = 2000,
                 na.action = "na.omit")

```

```{r}
# OVERSAMPLING
ctrl$sampling = "up"

formula <- formulas_0_12$dettecumulee
logmodel1_up <- train(formula, 
                  data = sample_train, 
                  method = 'glm',
                  family = binomial,
                  metric = 'AUC',
                  trControl = ctrl,
                  maxit = 2000,
                 na.action = "na.omit")

formula2 <- formulas_0_12$delais_bdf2
logmodel2_up <- train(formula2, 
                  data = sample_train, 
                  method = 'glm',
                  family = binomial,
                  metric = 'AUC',
                  trControl = ctrl,
                  maxit = 2000,
                 na.action = "na.omit")
```

```{r}
# SMOTE
ctrl$sampling = "smote"

formula <- formulas_0_12$dettecumulee
logmodel1_smote <- train(formula, 
                  data = sample_train, 
                  method = 'glm',
                  family = binomial,
                  metric = 'AUC',
                  trControl = ctrl,
                  maxit = 2000,
                 na.action = "na.omit")

formula2 <- formulas_0_12$delais_bdf2
rf2_smote <- train(formula2, 
                  data = sample_train, 
                  method = 'adaboost',
                  metric = 'AUC',
                  trControl = ctrl,
                  tuneLength = 5,
                 na.action = "na.omit")
```

```{r}

# ROSE
ctrl$sampling = "rose"

formula <- formulas_0_12$dettecumulee
logmodel1_rose <- train(formula, 
                  data = sample_train, 
                  method = 'glm',
                  family = binomial,
                  metric = 'AUC',
                  trControl = ctrl,
                  maxit = 2000,
                 na.action = "na.omit")

formula2 <- formulas_0_12$delais_bdf2
logmodel2_rose <- train(formula2, 
                  data = sample_train, 
                  method = 'glm',
                  family = binomial,
                  metric = 'AUC',
                  trControl = ctrl,
                  maxit = 2000,
                 na.action = "na.omit")
```

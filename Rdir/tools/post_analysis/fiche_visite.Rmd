---
title: "Fiche entreprise"
author: "Christophe Ninucci et Pierre Camilleri"
date: "17 mai 2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!exists('table_wholesample')){
load("~/Documents/opensignauxfaibles/Rdir/RData/1803/environnement_complet_mice_all_randomforest_mean3last.RData")
}

library(tidyverse)
library(tibbletime)
library(plotly)
monsiret = ''

etablissement <- table_wholesample %>% filter(siret == monsiret)



```



**Raison sociale**: `r first(etablissement$raison_sociale)`  
**Siret**: `r first(etablissement$siret)`  
**Departement**: `r first(etablissement$code_departement)` (`r first(etablissement$region)`)  
**APE**: `r first(etablissement$code_ape)` -> `r first(etablissement$libelle_naf_niveau5)`

**Sirets d'autres établissements connus avec le même siren**: `r unique(table_wholesample$siret %>% grep(pattern = substr(first(etablissement$siret),1,9),.,value=TRUE) %>% .[. != monsiret])`  
```{r echo=FALSE,include = FALSE}
memeAPE <- table_wholesample %>% filter(code_ape == first(etablissement$code_ape))
```

**Nombre d'etablissements connus avec le même code APE**: `r length(unique(memeAPE$siret))`

**Prédiction**: `r prediction[prediction$siret == monsiret,2]`  
**Rang prédiction**: `r prediction %>% arrange(desc(prob)) %>% mutate(rank = 1:length(prob)) %>% filter(siret ==monsiret) %>% .[['rank']]`/ `r n_distinct(table_wholesample$siret)` etablissements  
**Rang parmi les mêmes APE**: `r prediction %>% semi_join(memeAPE,by='siret') %>% arrange(desc(prob)) %>% mutate(rank = 1:length(prob)) %>% filter(siret == monsiret) %>% .[['rank']]`/ `r n_distinct(memeAPE$siret)` etablissements avec le même APE




## Effectif et activite partielle

```{r echo = FALSE}
  g <- ggplot(etablissement %>% mutate(activite_partielle_approx = effectif*apart_share_heuresconsommees),aes(x=periode,y=effectif)) +
    geom_line() + 
  expand_limits(y=0) +
  geom_area(aes(y=activite_partielle_approx,fill="activite partielle"))
ggplotly(g)
  
```

## Debits URSSAF

```{r echo=FALSE}
  g <- ggplot(etablissement %>% gather(c('montant_part_ouvriere','montant_part_patronale'),key = 'type_debit',value = 'debit'),aes(x=periode,y=debit,fill=type_debit)) +
    geom_area(position = 'stack') +
  geom_line(aes(y=mean_cotisation_due,color='cotisation_moyenne')) 
 g
```

## Ratios financiers

```{r echo = FALSE}
 g <-  etablissement %>% gather(c('poids_frng','taux_marge','delai_fournisseur','dette_fiscale','financier_ct','financier'),key='type_ratio',value='ratio') %>% arrange(periode) %>%
  mutate(type_ratio = factor(type_ratio,levels = c('poids_frng','taux_marge','delai_fournisseur','dette_fiscale','financier_ct','financier'))) %>%
  as_tbl_time(periode) %>% 
   collapse_by('1 y') %>%
    group_by(periode,type_ratio) %>% 
  summarize(ratio = first(ratio)) %>%
  ggplot(aes(x=periode,y=ratio,color=type_ratio,group=type_ratio)) +
    geom_point() +
    geom_step() +
    geom_hline(yintercept = 0) +
    facet_wrap(vars(type_ratio))  
ggplotly(g)
```
